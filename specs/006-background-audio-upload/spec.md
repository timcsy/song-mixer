# Feature Specification: 背景播放與音檔上傳支援

**Feature Branch**: `006-background-audio-upload`
**Created**: 2025-12-09
**Status**: Draft
**Input**: User description: "背景播放功能（切換分頁時音訊繼續播放）及音檔上傳支援（支援純音檔而非僅影片）"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 背景播放 (Priority: P1)

使用者在練習卡拉OK時，需要同時查看歌詞網站或其他資料。當切換到其他瀏覽器分頁或最小化視窗時，音訊應該繼續播放，讓使用者可以邊聽邊看其他內容。

**Why this priority**: 這是核心使用體驗的關鍵功能。使用者在練習唱歌時經常需要查看歌詞或其他資訊，如果每次切換分頁音訊就停止，將嚴重影響使用體驗。

**Independent Test**: 可以完全獨立測試 - 播放任何已處理的歌曲，切換到其他分頁，確認音訊持續播放。

**Acceptance Scenarios**:

1. **Given** 使用者正在播放已處理的歌曲, **When** 使用者切換到其他瀏覽器分頁, **Then** 音訊繼續播放且播放時間持續更新
2. **Given** 使用者正在播放已處理的歌曲, **When** 使用者最小化瀏覽器視窗, **Then** 音訊繼續播放
3. **Given** 使用者在背景播放中, **When** 使用者回到應用程式分頁, **Then** 播放進度條顯示正確的當前時間位置
4. **Given** 使用者在背景播放中, **When** 歌曲播放完畢, **Then** 播放狀態正確更新為停止

---

### User Story 2 - 音檔上傳 (Priority: P1)

使用者擁有純音訊檔案（如 MP3、WAV、FLAC 等）想要進行人聲分離處理。系統目前只支援影片檔案上傳，使用者需要能夠直接上傳音檔而不需要先轉換成影片格式。

**Why this priority**: 擴展支援的檔案類型是基本功能需求。許多使用者的音樂檔案是純音訊格式，強迫他們轉換為影片格式會造成不便。

**Independent Test**: 可以完全獨立測試 - 上傳一個 MP3 檔案，確認系統能夠處理並產生分離後的音軌。

**Acceptance Scenarios**:

1. **Given** 使用者在新增歌曲對話框中, **When** 使用者選擇或拖放 MP3 檔案, **Then** 檔案被接受並顯示音檔預覽
2. **Given** 使用者在新增歌曲對話框中, **When** 使用者選擇 WAV、FLAC、AAC、M4A、OGG 等音檔, **Then** 檔案被接受並可以處理
3. **Given** 使用者已選擇音檔, **When** 使用者點擊「開始處理」, **Then** 系統進行格式轉換和音源分離處理
4. **Given** 音檔處理完成, **When** 使用者查看結果, **Then** 顯示「純音訊模式」介面（無影片預覽區域）

---

### User Story 3 - 音檔預覽 (Priority: P2)

使用者在選擇音檔後，希望能在上傳前確認選擇的檔案是否正確。系統應該提供音訊預覽功能，讓使用者可以試聽檔案內容。

**Why this priority**: 改善使用者體驗，減少誤選檔案的情況，但不影響核心功能運作。

**Independent Test**: 可以獨立測試 - 選擇音檔後確認可以播放預覽。

**Acceptance Scenarios**:

1. **Given** 使用者已選擇音檔, **When** 檔案載入完成, **Then** 顯示音訊播放器控制項讓使用者預覽
2. **Given** 使用者正在預覽音檔, **When** 使用者點擊「移除」, **Then** 清除選擇並可以重新選擇檔案

---

### Edge Cases

- 使用者上傳損壞或無法解碼的音檔時，系統應顯示明確的錯誤訊息
- 使用者上傳非常長的音檔（超過 10 分鐘）時，處理進度應正確顯示
- 使用者在背景播放時關閉瀏覽器，重新開啟後應能從歌曲列表重新載入
- 使用者上傳的音檔取樣率非 44.1kHz 時，系統應自動轉換
- 使用者同時有影片和音訊來源的歌曲時，應能正確區分顯示方式

## Requirements *(mandatory)*

### Functional Requirements

**背景播放功能**

- **FR-001**: 系統 MUST 在使用者切換瀏覽器分頁時繼續播放音訊
- **FR-002**: 系統 MUST 在使用者最小化視窗時繼續播放音訊
- **FR-003**: 系統 MUST 在背景播放期間持續追蹤並更新播放時間
- **FR-004**: 系統 MUST 在使用者返回應用程式時正確顯示當前播放進度

**音檔上傳功能**

- **FR-005**: 系統 MUST 接受 MP3、WAV、FLAC、AAC、M4A、OGG、WMA、AIFF、OPUS 等常見音檔格式
- **FR-006**: 系統 MUST 在選擇音檔後顯示音訊播放器預覽介面
- **FR-007**: 系統 MUST 將上傳的音檔轉換為標準格式進行處理（44.1kHz、立體聲、16-bit PCM）
- **FR-008**: 系統 MUST 對純音檔完成處理後，在結果頁面顯示「純音訊模式」介面
- **FR-009**: 系統 MUST 在純音訊模式下禁用需要原始影片的匯出格式（如 MP4 影片匯出）
- **FR-010**: 系統 MUST 在拖放區域同時接受影片和音檔格式

### Key Entities

- **SongRecord**: 代表已處理的歌曲，包含原始來源類型（YouTube、影片上傳、音檔上傳）、分離後的音軌、以及可選的原始影片資料
- **ProcessingState**: 代表處理進度狀態，需支援音檔轉換階段的進度顯示

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者切換分頁後，音訊播放中斷率為 0%（完全不中斷）
- **SC-002**: 音檔上傳成功率達 95%（針對支援的格式）
- **SC-003**: 使用者從選擇音檔到開始處理的操作步驟不超過 3 步
- **SC-004**: 音檔處理完成後，使用者可以在 3 秒內開始播放結果
- **SC-005**: 系統支援至少 9 種常見音檔格式（MP3、WAV、FLAC、AAC、M4A、OGG、WMA、AIFF、OPUS）

## Assumptions

- 使用者的瀏覽器支援現代 Web Audio API 和 Page Visibility API
- 音檔大小上限與現有影片檔案限制相同（100MB 軟限制警告）
- 純音訊歌曲的儲存空間需求較小（無原始影片資料）
- 使用者理解純音訊模式下無法匯出包含影片的格式

## Out of Scope

- 系統媒體控制整合（如鎖定螢幕播放控制）- 可作為未來功能
- 批次上傳多個音檔
- 音檔格式自動偵測和修復（損壞檔案的復原）
- 背景播放時的通知功能
