# Feature Specification: 進階音軌控制功能

**Feature Branch**: `003-advanced-audio-mixer`
**Created**: 2025-11-28
**Status**: Draft
**Input**: User description: "進階音軌控制功能：多音軌選擇、升降 Key、導唱功能、多格式下載"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 預覽時調整音軌混音 (Priority: P1)

使用者在影片處理完成後，想要在預覽時即時調整各個音軌（鼓、貝斯、其他樂器、人聲）的音量，以找到最適合的伴奏組合。

**Why this priority**: 這是整個功能的核心，必須先有預覽功能才能讓使用者決定最終下載的設定。

**Independent Test**: 上傳一首影片，處理完成後在預覽頁面調整各軌道音量滑桿，即時聽到混音效果的變化。

**Acceptance Scenarios**:

1. **Given** 影片已處理完成，**When** 使用者點擊播放，**Then** 可以聽到預設的伴奏版本（去人聲）
2. **Given** 影片正在播放，**When** 使用者調整鼓聲音量滑桿，**Then** 鼓聲音量即時改變且不影響其他軌道
3. **Given** 影片正在播放，**When** 使用者將人聲音量從 0 調高，**Then** 可以聽到導唱效果
4. **Given** 影片正在播放，**When** 使用者拖動影片進度條，**Then** 音頻與影片保持同步

---

### User Story 2 - 升降 Key 調整 (Priority: P1)

使用者想要調整伴奏的音調高低，以配合自己的音域或喜好。

**Why this priority**: 升降 Key 是 KTV 伴奏的核心功能，與音軌混音同等重要。

**Independent Test**: 在預覽頁面調整升降 Key 控制，即時聽到音調變化。

**Acceptance Scenarios**:

1. **Given** 影片正在播放，**When** 使用者選擇升 2 個半音，**Then** 所有音軌的音調即時升高
2. **Given** 影片正在播放，**When** 使用者選擇降 3 個半音，**Then** 所有音軌的音調即時降低
3. **Given** 使用者已調整音調，**When** 使用者暫停再播放，**Then** 音調設定保持不變
4. **Given** 升降 Key 範圍，**When** 使用者嘗試調整，**Then** 只能在 ±12 半音範圍內調整

---

### User Story 3 - 導唱功能快速切換 (Priority: P2)

使用者想要快速開關人聲軌道，在練唱時可以參考原唱，也可以關閉人聲自己唱。

**Why this priority**: 導唱功能是基於音軌選擇的便捷操作，提升使用體驗。

**Independent Test**: 點擊「導唱開關」按鈕，即時切換人聲有無。

**Acceptance Scenarios**:

1. **Given** 影片正在播放且人聲為關閉狀態，**When** 使用者點擊「開啟導唱」，**Then** 人聲立即加入混音
2. **Given** 影片正在播放且人聲為開啟狀態，**When** 使用者點擊「關閉導唱」，**Then** 人聲立即從混音中移除
3. **Given** 使用者切換導唱狀態，**When** 切換完成，**Then** 按鈕文字更新顯示當前狀態

---

### User Story 4 - 自訂混音下載 (Priority: P2)

使用者調整好混音設定後，想要下載最終結果，並可選擇輸出格式。

**Why this priority**: 下載是整個流程的終點，使用者需要取得成品。

**Independent Test**: 調整好設定後點擊下載，選擇格式並成功下載檔案。

**Acceptance Scenarios**:

1. **Given** 使用者已調整混音設定，**When** 使用者點擊下載並選擇 MP4，**Then** 系統產生包含影片和混音的 MP4 檔案
2. **Given** 使用者已調整混音設定，**When** 使用者點擊下載並選擇 MP3，**Then** 系統產生純音頻的 MP3 檔案
3. **Given** 使用者已調整混音設定，**When** 使用者點擊下載並選擇 M4A，**Then** 系統產生 AAC 編碼的 M4A 檔案
4. **Given** 使用者已調整混音設定，**When** 使用者點擊下載並選擇 WAV，**Then** 系統產生無損音質的 WAV 檔案
5. **Given** 下載正在進行中，**When** 使用者查看介面，**Then** 顯示下載進度或準備狀態

---

### Edge Cases

- 當網路連線中斷時，預覽應暫停並顯示提示
- 當使用者同時將所有軌道音量設為 0 時，應播放靜音但影片繼續
- 當下載過程中使用者關閉頁面，下載應自動取消
- 當音軌檔案載入失敗時，應顯示錯誤訊息並允許重試
- 當瀏覽器不支援 Web Audio API 時，應顯示相容性提示

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統 MUST 將影片音頻分離為四個獨立軌道：鼓聲 (drums)、貝斯 (bass)、其他樂器 (other)、人聲 (vocals)
- **FR-002**: 系統 MUST 在預覽時允許使用者獨立調整每個軌道的音量（範圍 0% - 200%）
- **FR-003**: 系統 MUST 支援即時升降 Key 調整，範圍為 ±12 個半音
- **FR-004**: 系統 MUST 提供導唱開關按鈕，快速切換人聲軌道的開啟/關閉
- **FR-005**: 系統 MUST 支援四種輸出格式：MP4（含影片）、MP3、M4A、WAV
- **FR-006**: 系統 MUST 在預覽時保持音頻與影片的同步播放
- **FR-007**: 系統 MUST 在使用者調整設定後即時反映變化（延遲小於 100ms）
- **FR-008**: 系統 MUST 記住使用者的混音設定直到下載完成或離開頁面
- **FR-009**: 系統 MUST 在下載時根據使用者設定產生對應格式的檔案
- **FR-010**: 系統 MUST 顯示下載進度或等待狀態

### Key Entities

- **Track（音軌）**: 代表一個分離後的音頻軌道，包含軌道名稱、音頻資料、音量設定
- **MixSettings（混音設定）**: 使用者的當前混音偏好，包含各軌道音量、升降 Key 值、輸出格式
- **Job（任務）**: 處理任務的擴充，包含分離後的軌道路徑資訊

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者調整音量或升降 Key 後，聽到變化的延遲時間小於 100 毫秒
- **SC-002**: 音頻與影片的同步誤差小於 50 毫秒
- **SC-003**: 90% 的使用者能在 30 秒內找到並使用音軌調整功能
- **SC-004**: 下載的混音檔案品質與預覽時聽到的效果一致
- **SC-005**: 支援最長 10 分鐘的影片處理和預覽
- **SC-006**: 導唱開關的響應時間小於 50 毫秒

## Assumptions

- 使用者的瀏覽器支援 Web Audio API（現代瀏覽器皆支援）
- 使用者的裝置有足夠的記憶體載入 4 個音軌的音頻資料
- 影片長度不超過 10 分鐘（現有系統限制）
- 使用者願意等待後端產生高品質下載檔案（預估 1-2 分鐘）

## Out of Scope

- 即時變速播放功能
- 音頻視覺化（波形圖、頻譜圖）
- 音效處理（迴音、混響等）
- 多個混音設定的儲存與載入
- 離線使用支援
